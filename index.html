<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Financeiro Capivara Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fdf5e6;
        }

        .capivara-container {
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 180px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(93, 64, 55, 0.1);
        }

        @keyframes capy-idle {
            0%, 100% { transform: scale(1) translateY(0px); }
            50% { transform: scale(1.02) translateY(-5px); }
        }
        
        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        .capy-body {
            animation: capy-idle 4s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));
        }

        .capy-eye {
            transform-origin: center;
            animation: blink 4s infinite;
        }

        .category-tag {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 999px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active-gasto { background-color: #ef4444; color: white; }
        .tab-btn.active-ganho { background-color: #10b981; color: white; }
        .tab-btn.active-cartao { background-color: #8b5cf6; color: white; }
        
        .history-column {
            max-height: 400px;
            overflow-y: auto;
        }

        .total-expense-card {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #f87171;
        }

        /* Esconder input de arquivo padrÃ£o */
        #csv-upload { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#5d4037]">Capivara Financeira Pro ðŸ¦«</h1>
            <p class="text-gray-600">GestÃ£o com Saldo Acumulado e AnÃ¡lise de Categorias</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-6 text-center">
                    <h2 class="text-lg font-semibold mb-2 text-[#5d4037]">Mascote Capivara</h2>
                    <div id="capivara-mood" class="capivara-container"></div>
                    <div id="capivara-msg" class="text-sm font-medium mt-4">A carregar...</div>
                </div>

                <div class="card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-[#5d4037]">Resumo Financeiro</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Saldo Total</p>
                                <p id="total-balance" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Acumulado Anterior</p>
                            <p id="carried-balance" class="text-sm font-semibold text-gray-600">R$ 0,00</p>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <p class="text-xs text-gray-500 uppercase">Meta de PoupanÃ§a</p>
                                <p id="goal-percent" class="text-xs font-bold text-green-600">0%</p>
                            </div>
                            <input type="number" id="saving-goal" value="1000" oninput="updateUI()" class="w-full bg-transparent border-b-2 border-green-200 focus:border-green-500 outline-none font-semibold text-lg mb-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="goal-progress" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-[#5d4037]">Backup e Dados</h2>
                    <div class="space-y-3">
                        <button onclick="exportToCSV()" class="w-full flex items-center justify-center gap-2 bg-[#5d4037] text-white p-3 rounded-xl font-bold hover:bg-[#4e342e] transition-all shadow-md">
                            ðŸ“Š Exportar (Excel)
                        </button>
                        
                        <label for="csv-upload" class="w-full flex items-center justify-center gap-2 bg-white border-2 border-[#5d4037] text-[#5d4037] p-3 rounded-xl font-bold hover:bg-orange-50 cursor-pointer transition-all">
                            ðŸ“¥ Importar CSV
                        </label>
                        <input type="file" id="csv-upload" accept=".csv" onchange="importFromCSV(event)">
                        
                        <button onclick="clearAll()" class="w-full p-2 text-xs text-red-400 hover:text-red-600 transition-colors">
                            Limpar todos os dados
                        </button>
                    </div>
                </div>

                <!-- CATEGORIAS (Corrigido para aparecer agora) -->
                <div class="card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-[#5d4037]">Gastos por Categoria</h2>
                    <div id="category-breakdown" class="space-y-3">
                        <p class="text-gray-400 text-xs italic">Aguardando dados...</p>
                    </div>
                </div>
            </div>

            <!-- Principal -->
            <div class="lg:col-span-3 space-y-6">
                <!-- GrÃ¡fico -->
                <div class="card p-6">
                    <h2 class="text-lg font-semibold mb-4 text-[#5d4037]">EvoluÃ§Ã£o Mensal</h2>
                    <div class="h-[250px] w-full">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>

                <!-- Resumo Consolidado -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-4 total-expense-card">
                        <p class="text-[10px] text-red-700 font-bold uppercase">Gasto Total do MÃªs</p>
                        <p id="consolidated-expense-total" class="text-2xl font-black text-red-600">R$ 0,00</p>
                    </div>
                    <div class="card p-4 bg-red-50 border border-red-100">
                        <p class="text-[10px] text-red-500 font-bold uppercase">Total DÃ©bito</p>
                        <p id="summary-debit-total" class="text-xl font-bold text-red-500">R$ 0,00</p>
                    </div>
                    <div class="card p-4 bg-purple-50 border border-purple-100">
                        <p class="text-[10px] text-purple-500 font-bold uppercase">Total CartÃ£o</p>
                        <p id="summary-credit-total" class="text-xl font-bold text-purple-500">R$ 0,00</p>
                    </div>
                </div>

                <!-- FormulÃ¡rio -->
                <div class="card p-6 border-t-4 border-[#5d4037]" id="transaction-card">
                    <h2 class="text-lg font-semibold mb-4 text-[#5d4037]">Nova TransaÃ§Ã£o</h2>
                    <div class="flex gap-2 mb-6 bg-gray-100 p-1 rounded-xl">
                        <button onclick="setTransactionType('gasto')" id="btn-tab-gasto" class="tab-btn active-gasto flex-1 py-2 px-4 rounded-lg font-bold text-sm flex items-center justify-center gap-2">ðŸ’¸ DÃ©bito</button>
                        <button onclick="setTransactionType('cartao')" id="btn-tab-cartao" class="tab-btn flex-1 py-2 px-4 rounded-lg font-bold text-sm text-gray-500 flex items-center justify-center gap-2">ðŸ’³ CartÃ£o</button>
                        <button onclick="setTransactionType('ganho')" id="btn-tab-ganho" class="tab-btn flex-1 py-2 px-4 rounded-lg font-bold text-sm text-gray-500 flex items-center justify-center gap-2">ðŸ’° Ganho</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="desc" placeholder="DescriÃ§Ã£o" class="col-span-2 p-3 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-[#5d4037]">
                        <div class="relative col-span-2 md:col-span-1">
                            <span class="absolute left-3 top-3 text-gray-400 font-bold">R$</span>
                            <input type="number" id="val" placeholder="0,00" class="w-full p-3 pl-10 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-[#5d4037]">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <input type="date" id="transaction-date" class="w-full p-3 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-[#5d4037]">
                        </div>
                        <select id="category" class="col-span-2 p-3 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-[#5d4037]"></select>
                        <button id="main-submit-btn" onclick="addTransaction()" class="col-span-2 p-4 bg-red-500 text-white font-bold rounded-lg hover:opacity-90 transition-all shadow-lg">Confirmar LanÃ§amento</button>
                    </div>
                </div>

                <!-- HistÃ³rico -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-[#5d4037]">HistÃ³rico do MÃªs</h2>
                        <select id="month-filter" onchange="updateMonthContext()" class="text-sm font-bold bg-gray-100 p-2 rounded-lg outline-none text-[#5d4037]"></select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-green-50/30 p-3 rounded-xl">
                            <h3 class="font-bold text-green-700 text-sm mb-4 border-b-2 border-green-500">Ganhos</h3>
                            <div class="history-column"><table class="w-full text-left"><tbody id="income-list"></tbody></table><div id="income-empty" class="hidden text-center py-4 text-gray-400 text-xs">Vazio.</div></div>
                            <div class="mt-4 pt-2 border-t font-bold text-green-600 text-sm" id="subtotal-income">R$ 0,00</div>
                        </div>
                        <div class="bg-red-50/30 p-3 rounded-xl">
                            <h3 class="font-bold text-red-700 text-sm mb-4 border-b-2 border-red-500">DÃ©bitos</h3>
                            <div class="history-column"><table class="w-full text-left"><tbody id="expense-list"></tbody></table><div id="expense-empty" class="hidden text-center py-4 text-gray-400 text-xs">Vazio.</div></div>
                            <div class="mt-4 pt-2 border-t font-bold text-red-600 text-sm" id="subtotal-expense">R$ 0,00</div>
                        </div>
                        <div class="bg-purple-50/30 p-3 rounded-xl">
                            <h3 class="font-bold text-purple-700 text-sm mb-4 border-b-2 border-purple-500">CartÃ£o</h3>
                            <div class="history-column"><table class="w-full text-left"><tbody id="credit-list"></tbody></table><div id="credit-empty" class="hidden text-center py-4 text-gray-400 text-xs">Vazio.</div></div>
                            <div class="mt-4 pt-2 border-t font-bold text-purple-600 text-sm" id="subtotal-credit">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('capivara_finance_data')) || [];
        let currentType = 'gasto';
        let evolutionChart = null;

        const categoryColors = {
            'Lazer': 'bg-pink-100 text-pink-600', 'AlimentaÃ§Ã£o': 'bg-orange-100 text-orange-600',
            'Transporte': 'bg-blue-100 text-blue-600', 'SaÃºde': 'bg-red-100 text-red-600',
            'EducaÃ§Ã£o': 'bg-indigo-100 text-indigo-600', 'Casa': 'bg-amber-100 text-amber-600',
            'Renda': 'bg-green-100 text-green-600', 'Investimento': 'bg-emerald-100 text-emerald-600',
            'Outros': 'bg-gray-100 text-gray-600'
        };

        const expenseCategories = [
            { id: 'AlimentaÃ§Ã£o', label: 'ðŸ• AlimentaÃ§Ã£o' }, { id: 'Casa', label: 'ðŸ  Casa' },
            { id: 'Transporte', label: 'ðŸš— Transporte' }, { id: 'Lazer', label: 'ðŸŽ¡ Lazer' },
            { id: 'SaÃºde', label: 'ðŸ¥ SaÃºde' }, { id: 'EducaÃ§Ã£o', label: 'ðŸ“š EducaÃ§Ã£o' },
            { id: 'Outros', label: 'âš™ï¸ Outros Gastos' }
        ];

        const incomeCategories = [
            { id: 'Renda', label: 'ðŸ’° SalÃ¡rio' }, { id: 'Investimento', label: 'ðŸ“ˆ Rendimentos' },
            { id: 'Outros', label: 'ðŸŽ Outros Ganhos' }
        ];

        function setTransactionType(type) {
            currentType = type;
            const btnGasto = document.getElementById('btn-tab-gasto');
            const btnGanho = document.getElementById('btn-tab-ganho');
            const btnCartao = document.getElementById('btn-tab-cartao');
            const submitBtn = document.getElementById('main-submit-btn');

            [btnGasto, btnGanho, btnCartao].forEach(b => b.className = 'tab-btn flex-1 py-2 px-4 rounded-lg font-bold text-sm text-gray-500');

            if (type === 'gasto') {
                btnGasto.className = 'tab-btn active-gasto flex-1 py-2 px-4 rounded-lg font-bold text-sm';
                submitBtn.innerText = 'LanÃ§ar Gasto DÃ©bito';
                submitBtn.className = 'col-span-2 p-4 bg-red-500 text-white font-bold rounded-lg hover:opacity-90 transition-all shadow-lg';
                populateCategories(expenseCategories);
            } else if (type === 'cartao') {
                btnCartao.className = 'tab-btn active-cartao flex-1 py-2 px-4 rounded-lg font-bold text-sm';
                submitBtn.innerText = 'LanÃ§ar Gasto CartÃ£o';
                submitBtn.className = 'col-span-2 p-4 bg-purple-500 text-white font-bold rounded-lg hover:opacity-90 transition-all shadow-lg';
                populateCategories(expenseCategories);
            } else {
                btnGanho.className = 'tab-btn active-ganho flex-1 py-2 px-4 rounded-lg font-bold text-sm';
                submitBtn.innerText = 'LanÃ§ar Ganho';
                submitBtn.className = 'col-span-2 p-4 bg-emerald-500 text-white font-bold rounded-lg hover:opacity-90 transition-all shadow-lg';
                populateCategories(incomeCategories);
            }
        }

        function populateCategories(cats) {
            const select = document.getElementById('category');
            select.innerHTML = cats.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
        }

        const drawCapivara = (mood) => {
            let color = "#8D6E63";
            let mouth = `<path d="M140 120 Q150 130 160 120" stroke="black" stroke-width="3" fill="none" stroke-linecap="round"/>`;
            if (mood === 'sad') {
                color = "#6D4C41";
                mouth = `<path d="M140 130 Q150 120 160 130" stroke="black" stroke-width="3" fill="none" stroke-linecap="round"/>`;
            } else if (mood === 'party') {
                color = "#A1887F";
                mouth = `<path d="M140 120 Q155 140 170 120" stroke="black" stroke-width="3" fill="none" stroke-linecap="round"/>`;
            }
            return `<svg class="w-40 h-40 capy-body" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="65" cy="75" rx="12" ry="15" fill="${color}" stroke="#3E2723" stroke-width="2"/>
                <ellipse cx="110" cy="65" rx="10" ry="12" fill="${color}" stroke="#3E2723" stroke-width="2"/>
                <path d="M40 120 C40 60, 160 60, 180 120 C180 170, 40 170, 40 120" fill="${color}" stroke="#3E2723" stroke-width="2"/>
                <g class="capy-eye"><circle cx="140" cy="95" r="5" fill="black"/><circle cx="142" cy="93" r="1.5" fill="white"/></g>
                ${mouth}
                <rect x="70" y="155" width="22" height="18" rx="8" fill="#3E2723"/><rect x="130" y="155" width="22" height="18" rx="8" fill="#3E2723"/>
            </svg>`;
        };

        function addTransaction() {
            const desc = document.getElementById('desc').value;
            const val = parseFloat(document.getElementById('val').value);
            const dateInput = document.getElementById('transaction-date').value;
            const category = document.getElementById('category').value;
            if (!desc || isNaN(val) || !dateInput) return;
            const dateObj = new Date(dateInput + "T12:00:00");
            
            let amount = val;
            let subType = 'income';
            if(currentType === 'gasto') { amount = -val; subType = 'debit'; }
            if(currentType === 'cartao') { amount = -val; subType = 'credit'; }

            const monthYear = `${dateObj.getFullYear()}-${dateObj.getMonth() + 1}`;
            transactions.push({
                id: Date.now(), description: desc, amount: amount,
                category: category, monthYear: monthYear, 
                day: dateObj.getDate(), date: dateObj.toLocaleDateString('pt-BR'),
                subType: subType
            });
            transactions.sort((a, b) => b.id - a.id);
            saveData();
            document.getElementById('desc').value = '';
            document.getElementById('val').value = '';
            updateUI();
        }

        function exportToCSV() {
            if (transactions.length === 0) return alert("Nada para exportar.");
            let csv = "ID,Data,Descricao,Valor,Categoria,TipoInterno\n";
            transactions.forEach(t => {
                csv += `${t.id},${t.date},"${t.description.replace(/"/g, '""')}",${t.amount},${t.category},${t.subType}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `capivara_backup_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                let importedCount = 0;

                rows.forEach(row => {
                    if (!row.trim()) return;
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (cols.length < 6) return;

                    const id = parseInt(cols[0]);
                    const dateStr = cols[1];
                    const description = cols[2].replace(/"/g, '');
                    const amount = parseFloat(cols[3]);
                    const category = cols[4];
                    const subType = cols[5].trim();

                    if (!transactions.some(t => t.id === id)) {
                        const [d, m, y] = dateStr.split('/');
                        transactions.push({
                            id: id || Date.now() + Math.random(),
                            date: dateStr,
                            description: description,
                            amount: amount,
                            category: category,
                            subType: subType,
                            monthYear: `${y}-${parseInt(m)}`,
                            day: parseInt(d)
                        });
                        importedCount++;
                    }
                });

                transactions.sort((a, b) => b.id - a.id);
                saveData();
                updateUI();
                alert(`${importedCount} transaÃ§Ãµes importadas!`);
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function updateMonthContext() { updateUI(); }
        function deleteTransaction(id) { transactions = transactions.filter(t => t.id !== id); saveData(); updateUI(); }
        function saveData() { localStorage.setItem('capivara_finance_data', JSON.stringify(transactions)); }
        function clearAll() { if(confirm("Apagar tudo?")) { transactions = []; saveData(); updateUI(); } }

        function initChart() {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [
                    { label: 'Ganhos', borderColor: '#10b981', data: [], tension: 0.3 },
                    { label: 'DÃ©bitos', borderColor: '#ef4444', data: [], tension: 0.3 },
                    { label: 'CartÃ£o', borderColor: '#8b5cf6', data: [], tension: 0.3 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', min: 1, max: 31 } } }
            });
        }

        function createRow(t) {
            return `
                <tr class="border-b border-gray-50">
                    <td class="py-2">
                        <p class="text-[8px] text-gray-400 font-bold">${t.date}</p>
                        <p class="font-medium text-gray-800 text-[10px] truncate w-24">${t.description}</p>
                    </td>
                    <td class="py-2 text-right font-bold text-[10px] ${t.amount >= 0 ? 'text-green-600' : (t.subType === 'credit' ? 'text-purple-600' : 'text-red-600')}">
                        ${Math.abs(t.amount).toLocaleString('pt-BR')}
                    </td>
                    <td class="text-right"><button onclick="deleteTransaction(${t.id})" class="text-gray-300 hover:text-red-500">âœ•</button></td>
                </tr>
            `;
        }

        function updateUI() {
            const incomeList = document.getElementById('income-list');
            const expenseList = document.getElementById('expense-list');
            const creditList = document.getElementById('credit-list');
            const breakdownEl = document.getElementById('category-breakdown');
            const selectedMonth = document.getElementById('month-filter').value;
            const [selYear, selMonth] = selectedMonth.split('-').map(Number);
            
            let carriedBalance = 0;
            transactions.forEach(t => {
                const [tYear, tMonth] = t.monthYear.split('-').map(Number);
                if (tYear < selYear || (tYear === selYear && tMonth < selMonth)) carriedBalance += t.amount;
            });

            document.getElementById('carried-balance').innerText = carriedBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            let sumIncome = 0, sumExpense = 0, sumCredit = 0, totalExpGlobal = 0, monthBalance = 0;
            let catTotals = {}, gainsMap = {}, debitsMap = {}, creditsMap = {};

            incomeList.innerHTML = ''; expenseList.innerHTML = ''; creditList.innerHTML = '';
            
            transactions.filter(t => t.monthYear === selectedMonth).forEach(t => {
                monthBalance += t.amount;
                const d = t.day;
                if (t.amount >= 0) {
                    sumIncome += t.amount;
                    gainsMap[d] = (gainsMap[d] || 0) + t.amount;
                    incomeList.innerHTML += createRow(t);
                } else {
                    const absVal = Math.abs(t.amount);
                    totalExpGlobal += absVal;
                    catTotals[t.category] = (catTotals[t.category] || 0) + absVal;
                    if(t.subType === 'credit') {
                        sumCredit += absVal;
                        creditsMap[d] = (creditsMap[d] || 0) + absVal;
                        creditList.innerHTML += createRow(t);
                    } else {
                        sumExpense += absVal;
                        debitsMap[d] = (debitsMap[d] || 0) + absVal;
                        expenseList.innerHTML += createRow(t);
                    }
                }
            });

            // ATUALIZAR LISTA DE CATEGORIAS (BARRA LATERAL)
            breakdownEl.innerHTML = '';
            if (totalExpGlobal === 0) {
                breakdownEl.innerHTML = '<p class="text-gray-400 text-xs italic">Sem gastos neste mÃªs.</p>';
            } else {
                Object.keys(catTotals).sort((a,b) => catTotals[b] - catTotals[a]).forEach(cat => {
                    const perc = (catTotals[cat] / totalExpGlobal) * 100;
                    const colorClass = categoryColors[cat]?.split(' ')[0] || 'bg-gray-400';
                    breakdownEl.innerHTML += `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 font-bold">
                                <span class="text-gray-600">${cat}</span>
                                <span class="text-[#5d4037]">${perc.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                <div class="h-full rounded-full ${colorClass} transition-all duration-700" style="width: ${perc}%"></div>
                            </div>
                            <p class="text-[8px] text-right text-gray-400 mt-0.5">R$ ${catTotals[cat].toLocaleString('pt-BR')}</p>
                        </div>
                    `;
                });
            }

            document.getElementById('summary-debit-total').innerText = sumExpense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summary-credit-total').innerText = sumCredit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('consolidated-expense-total').innerText = (sumExpense + sumCredit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('subtotal-income').innerText = sumIncome.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('subtotal-expense').innerText = sumExpense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('subtotal-credit').innerText = sumCredit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            document.getElementById('income-empty').style.display = sumIncome === 0 ? 'block' : 'none';
            document.getElementById('expense-empty').style.display = sumExpense === 0 ? 'block' : 'none';
            document.getElementById('credit-empty').style.display = sumCredit === 0 ? 'block' : 'none';

            if (evolutionChart) {
                evolutionChart.data.datasets[0].data = Object.keys(gainsMap).map(d => ({x: parseInt(d), y: gainsMap[d]})).sort((a,b) => a.x - b.x);
                evolutionChart.data.datasets[1].data = Object.keys(debitsMap).map(d => ({x: parseInt(d), y: debitsMap[d]})).sort((a,b) => a.x - b.x);
                evolutionChart.data.datasets[2].data = Object.keys(creditsMap).map(d => ({x: parseInt(d), y: creditsMap[d]})).sort((a,b) => a.x - b.x);
                evolutionChart.update();
            }

            const finalBalance = carriedBalance + monthBalance;
            const balanceEl = document.getElementById('total-balance');
            balanceEl.innerText = finalBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            balanceEl.className = `text-2xl font-bold ${finalBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            const goal = parseFloat(document.getElementById('saving-goal').value) || 0;
            const pGoal = goal > 0 ? Math.min((finalBalance/goal)*100, 100) : 0;
            document.getElementById('goal-progress').style.width = Math.max(0, pGoal) + '%';
            document.getElementById('goal-percent').innerText = Math.floor(pGoal) + '%';

            document.getElementById('capivara-mood').innerHTML = finalBalance < 0 ? drawCapivara('sad') : (finalBalance >= goal && goal > 0 ? drawCapivara('party') : drawCapivara('happy'));
            document.getElementById('capivara-msg').innerText = finalBalance < 0 ? "A Capivara estÃ¡ preocupada!" : "Tudo sob controle!";
        }

        function setupFilter() {
            const filter = document.getElementById('month-filter');
            const months = ["Janeiro", "Fevereiro", "MarÃ§o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const now = new Date();
            for (let year = 2024; year <= 2026; year++) {
                months.forEach((m, i) => {
                    const opt = document.createElement('option');
                    opt.value = `${year}-${i + 1}`;
                    opt.innerText = `${m} ${year}`;
                    if(`${year}-${i + 1}` === `${now.getFullYear()}-${now.getMonth() + 1}`) opt.selected = true;
                    filter.appendChild(opt);
                });
            }
        }

        window.onload = () => {
            setupFilter();
            setTransactionType('gasto');
            initChart();
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            updateUI();
        };
    </script>
</body>
</html>
